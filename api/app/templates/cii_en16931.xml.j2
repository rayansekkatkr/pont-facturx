<?xml version="1.0" encoding="UTF-8"?>
<!-- Factur-X / CII EN16931 (COMFORT) with invoice lines -->
<rsm:CrossIndustryInvoice
  xmlns:rsm="urn:un:unece:uncefact:data:standard:CrossIndustryInvoice:100"
  xmlns:ram="urn:un:unece:uncefact:data:standard:ReusableAggregateBusinessInformationEntity:100"
  xmlns:udt="urn:un:unece:uncefact:data:standard:UnqualifiedDataType:100">

  {% set seller = invoice.get('seller', {}) %}
  {% set buyer  = invoice.get('buyer', {}) %}
  {% set totals = invoice.get('totals', {}) %}
  {% set lines  = invoice.get('lines', []) %}

  {% set currency = invoice.get('currency') or 'EUR' %}
  {% set inv_no = invoice.get('invoice_number') or invoice.get('id') or 'INV-UNKNOWN' %}
  {% set issue_date = invoice.get('issue_date') or '1970-01-01' %}

  {% set total_ht = totals.get('total_ht') if totals.get('total_ht') is not none else 0 %}
  {% set total_vat = totals.get('total_vat') if totals.get('total_vat') is not none else 0 %}
  {% set total_ttc = totals.get('total_ttc') if totals.get('total_ttc') is not none else (total_ht|float + total_vat|float) %}

  {% set vat_rate = invoice.get('vat_rate') %}
  {% if vat_rate is none %}
    {% set vat_rate = totals.get('vat_rate') %}
  {% endif %}
  {% if vat_rate is none %}
    {% if (total_ht|float) > 0 and (total_vat|float) > 0 %}
      {% set vat_rate = (total_vat|float / total_ht|float * 100) %}
    {% else %}
      {% set vat_rate = 0 %}
    {% endif %}
  {% endif %}

  {% set vat_category = invoice.get('vat_category') %}
  {% if not vat_category %}
    {% if (vat_rate|float) == 0 %}
      {% set vat_category = 'Z' %}
    {% else %}
      {% set vat_category = 'S' %}
    {% endif %}
  {% endif %}

  <rsm:ExchangedDocumentContext>
    <ram:GuidelineSpecifiedDocumentContextParameter>
      <ram:ID>urn:cen.eu:en16931:2017#compliant#urn:factur-x.eu:1p0:extended</ram:ID>
    </ram:GuidelineSpecifiedDocumentContextParameter>
  </rsm:ExchangedDocumentContext>

  <rsm:ExchangedDocument>
    <ram:ID>{{ inv_no }}</ram:ID>
    <ram:TypeCode>380</ram:TypeCode>
    <ram:IssueDateTime>
      <udt:DateTimeString format="102">{{ issue_date|date102 }}</udt:DateTimeString>
    </ram:IssueDateTime>
  </rsm:ExchangedDocument>

  <rsm:SupplyChainTradeTransaction>

    <!-- INVOICE LINES (BR-16: at least one required for EN16931) -->
    {% for line in lines %}
    <ram:IncludedSupplyChainTradeLineItem>
      <ram:AssociatedDocumentLineDocument>
        <ram:LineID>{{ line.get('line_id') or loop.index }}</ram:LineID>
      </ram:AssociatedDocumentLineDocument>

      <ram:SpecifiedTradeProduct>
        <ram:Name>{{ line.get('description') or 'Prestation' }}</ram:Name>
      </ram:SpecifiedTradeProduct>

      <ram:SpecifiedLineTradeAgreement>
        <ram:GrossPriceProductTradePrice>
          <ram:ChargeAmount>{{ '%.2f' % (line.get('unit_price')|float) }}</ram:ChargeAmount>
        </ram:GrossPriceProductTradePrice>
        <ram:NetPriceProductTradePrice>
          <ram:ChargeAmount>{{ '%.2f' % (line.get('unit_price')|float) }}</ram:ChargeAmount>
        </ram:NetPriceProductTradePrice>
      </ram:SpecifiedLineTradeAgreement>

      <ram:SpecifiedLineTradeDelivery>
        <ram:BilledQuantity unitCode="C62">{{ '%.2f' % (line.get('quantity')|float) }}</ram:BilledQuantity>
      </ram:SpecifiedLineTradeDelivery>

      <ram:SpecifiedLineTradeSettlement>
        <ram:ApplicableTradeTax>
          <ram:TypeCode>VAT</ram:TypeCode>
          <ram:CategoryCode>{{ line.get('vat_category') or vat_category }}</ram:CategoryCode>
          <ram:RateApplicablePercent>{{ '%.2f' % (line.get('vat_rate')|float) }}</ram:RateApplicablePercent>
        </ram:ApplicableTradeTax>
        <ram:SpecifiedTradeSettlementLineMonetarySummation>
          <ram:LineTotalAmount>{{ '%.2f' % (line.get('total')|float) }}</ram:LineTotalAmount>
        </ram:SpecifiedTradeSettlementLineMonetarySummation>
      </ram:SpecifiedLineTradeSettlement>

    </ram:IncludedSupplyChainTradeLineItem>
    {% endfor %}

    <ram:ApplicableHeaderTradeAgreement>

      <!-- SELLER -->
      <ram:SellerTradeParty>
        {% if seller.get('id') %}<ram:ID>{{ seller.get('id') }}</ram:ID>{% endif %}
        <ram:Name>{{ seller.get('name') or 'UNKNOWN' }}</ram:Name>

        {% set addr = seller.get('address', {}) %}
        <ram:PostalTradeAddress>
          {% if addr.get('line1') %}<ram:LineOne>{{ addr.get('line1') }}</ram:LineOne>{% endif %}
          {% if addr.get('line2') %}<ram:LineTwo>{{ addr.get('line2') }}</ram:LineTwo>{% endif %}
          {% if addr.get('postcode') %}<ram:PostalCodeCode>{{ addr.get('postcode') }}</ram:PostalCodeCode>{% endif %}
          {% if addr.get('city') %}<ram:CityName>{{ addr.get('city') }}</ram:CityName>{% endif %}
          <ram:CountryID>{{ addr.get('country') or 'FR' }}</ram:CountryID>
        </ram:PostalTradeAddress>

        {% if seller.get('vat_id') %}
        <ram:SpecifiedTaxRegistration>
          <ram:ID schemeID="VA">{{ seller.get('vat_id') }}</ram:ID>
        </ram:SpecifiedTaxRegistration>
        {% endif %}
      </ram:SellerTradeParty>

      <!-- BUYER -->
      <ram:BuyerTradeParty>
        {% if buyer.get('id') %}<ram:ID>{{ buyer.get('id') }}</ram:ID>{% endif %}
        <ram:Name>{{ buyer.get('name') or 'UNKNOWN' }}</ram:Name>

        {% set baddr = buyer.get('address', {}) %}
        <ram:PostalTradeAddress>
          {% if baddr.get('line1') %}<ram:LineOne>{{ baddr.get('line1') }}</ram:LineOne>{% endif %}
          {% if baddr.get('line2') %}<ram:LineTwo>{{ baddr.get('line2') }}</ram:LineTwo>{% endif %}
          {% if baddr.get('postcode') %}<ram:PostalCodeCode>{{ baddr.get('postcode') }}</ram:PostalCodeCode>{% endif %}
          {% if baddr.get('city') %}<ram:CityName>{{ baddr.get('city') }}</ram:CityName>{% endif %}
          <ram:CountryID>{{ baddr.get('country') or 'FR' }}</ram:CountryID>
        </ram:PostalTradeAddress>

        {% if buyer.get('vat_id') %}
        <ram:SpecifiedTaxRegistration>
          <ram:ID schemeID="VA">{{ buyer.get('vat_id') }}</ram:ID>
        </ram:SpecifiedTaxRegistration>
        {% endif %}
      </ram:BuyerTradeParty>

    </ram:ApplicableHeaderTradeAgreement>

    <ram:ApplicableHeaderTradeDelivery/>

    <ram:ApplicableHeaderTradeSettlement>

      <ram:InvoiceCurrencyCode>{{ currency }}</ram:InvoiceCurrencyCode>

      <ram:ApplicableTradeTax>
        <ram:CalculatedAmount>{{ '%.2f' % (total_vat|float) }}</ram:CalculatedAmount>
        <ram:TypeCode>VAT</ram:TypeCode>
        <ram:BasisAmount>{{ '%.2f' % (total_ht|float) }}</ram:BasisAmount>
        <ram:CategoryCode>{{ vat_category }}</ram:CategoryCode>
        <ram:RateApplicablePercent>{{ '%.2f' % (vat_rate|float) }}</ram:RateApplicablePercent>
      </ram:ApplicableTradeTax>

      <ram:SpecifiedTradePaymentTerms>
        {% if invoice.get('payment_terms') %}
        <ram:Description>{{ invoice.get('payment_terms') }}</ram:Description>
        {% endif %}
        {% if invoice.get('due_date') %}
        <ram:DueDateDateTime>
          <udt:DateTimeString format="102">{{ invoice.get('due_date')|date102 }}</udt:DateTimeString>
        </ram:DueDateDateTime>
        {% endif %}
      </ram:SpecifiedTradePaymentTerms>

      <ram:SpecifiedTradeSettlementHeaderMonetarySummation>
        <ram:LineTotalAmount>{{ '%.2f' % (total_ht|float) }}</ram:LineTotalAmount>
        <ram:TaxBasisTotalAmount>{{ '%.2f' % (total_ht|float) }}</ram:TaxBasisTotalAmount>
        <ram:TaxTotalAmount currencyID="{{ currency }}">
          <ram:TotalAmount>{{ '%.2f' % (total_vat|float) }}</ram:TotalAmount>
        </ram:TaxTotalAmount>
        <ram:GrandTotalAmount>{{ '%.2f' % (total_ttc|float) }}</ram:GrandTotalAmount>
        <ram:DuePayableAmount>{{ '%.2f' % (total_ttc|float) }}</ram:DuePayableAmount>
      </ram:SpecifiedTradeSettlementHeaderMonetarySummation>

    </ram:ApplicableHeaderTradeSettlement>

  </rsm:SupplyChainTradeTransaction>
</rsm:CrossIndustryInvoice>
