name: Publish Images (Scaleway Registry)

on:
  push:
    branches: [main]
    tags:
      - "v*"
  workflow_dispatch:

concurrency:
  group: publish-images-scaleway
  cancel-in-progress: true

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: api
            context: ./api
            dockerfile: ./api/Dockerfile.api
            image_suffix: api
          - name: worker
            context: ./api
            dockerfile: ./api/Dockerfile.worker
            image_suffix: worker

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate registry configuration
        shell: bash
        run: |
          set -euo pipefail

          # SCW_REGISTRY should be the full registry prefix, e.g.
          #   rg.fr-par.scw.cloud/ns-facturx
          if [ -z "${{ secrets.SCW_REGISTRY }}" ]; then
            echo "Missing SCW_REGISTRY (Actions Secret). Example: rg.fr-par.scw.cloud/<namespace>" >&2
            exit 1
          fi

          # Scaleway CR typically uses Secret Key as docker password.
          if [ -z "${{ secrets.SCW_SECRET_KEY }}" ]; then
            echo "Missing SCW_SECRET_KEY (Actions Secret)" >&2
            exit 1
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Scaleway Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.SCW_REGISTRY_HOST || 'rg.fr-par.scw.cloud' }}
          username: ${{ secrets.SCW_REGISTRY_USERNAME || 'nologin' }}
          password: ${{ secrets.SCW_SECRET_KEY }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ secrets.SCW_REGISTRY }}/pont-facturx-${{ matrix.image_suffix }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,format=short
            type=ref,event=tag

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: true
          platforms: linux/amd64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  deploy-serverless-containers:
    name: Deploy (Scaleway Serverless Containers)
    runs-on: ubuntu-latest
    environment: production
    needs: build-and-push
    if: ${{ github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/') }}

    env:
      SCW_SECRET_KEY: ${{ secrets.SCW_SECRET_KEY }}
      SCW_REGION: ${{ secrets.SCW_REGION }}
      SCW_REGISTRY: ${{ secrets.SCW_REGISTRY }}
      SCW_CONTAINER_ID_API: ${{ secrets.SCW_CONTAINER_ID_API }}
      SCW_CONTAINER_ID_WORKER: ${{ secrets.SCW_CONTAINER_ID_WORKER }}

    steps:
      - name: Validate deploy configuration
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${SCW_SECRET_KEY:-}" ]; then
            echo "Missing SCW_SECRET_KEY (Actions Secret)" >&2
            exit 1
          fi
          if [ -z "${SCW_REGION:-}" ]; then
            echo "Missing SCW_REGION (Actions Secret). Example: fr-par" >&2
            exit 1
          fi
          if [ -z "${SCW_REGISTRY:-}" ]; then
            echo "Missing SCW_REGISTRY (Actions Secret). Example: rg.fr-par.scw.cloud/<namespace>" >&2
            exit 1
          fi

          # At least one container id must be set to proceed.
          if [ -z "${SCW_CONTAINER_ID_API:-}" ] && [ -z "${SCW_CONTAINER_ID_WORKER:-}" ]; then
            echo "Neither SCW_CONTAINER_ID_API nor SCW_CONTAINER_ID_WORKER are set; skipping deploy." >&2
            exit 0
          fi

      - name: Compute image tag
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          short_sha="${GITHUB_SHA::7}"
          echo "tag=sha-${short_sha}" >> "$GITHUB_OUTPUT"

      - name: Deploy API container
        if: ${{ env.SCW_CONTAINER_ID_API != '' }}
        shell: bash
        run: |
          set -euo pipefail

          region="${SCW_REGION}"
          container_id="${SCW_CONTAINER_ID_API}"
          image="${SCW_REGISTRY}/pont-facturx-api:${{ steps.vars.outputs.tag }}"

          echo "Target (API): region='${region}' container_id='${container_id}'"
          if ! [[ "$container_id" =~ ^[0-9a-fA-F-]{36}$ ]]; then
            echo "WARN: SCW_CONTAINER_ID_API doesn't look like a UUID: '${container_id}'" >&2
          fi

          container_url="https://api.scaleway.com/containers/v1beta1/regions/${region}/containers/${container_id}"
          echo "Preflight GET ${container_url}"
          http_code="$(curl -sS -o /tmp/scw_container_api.json -w "%{http_code}" \
            -H "X-Auth-Token: ${SCW_SECRET_KEY}" \
            -H "Accept: application/json" \
            "${container_url}" || true)"
          if [ "${http_code}" != "200" ]; then
            echo "ERROR: Preflight GET failed (HTTP ${http_code}). Check SCW_REGION/SCW_CONTAINER_ID_API/SCW_SECRET_KEY project." >&2
            cat /tmp/scw_container_api.json || true
            exit 1
          fi

          echo "Updating API container to ${image}"
          patch_resp="$(
            curl -fsS -X PATCH \
            -H "X-Auth-Token: ${SCW_SECRET_KEY}" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            "https://api.scaleway.com/containers/v1beta1/regions/${region}/containers/${container_id}" \
            -d "{\"registry_image\":\"${image}\"}" \
          )"

          echo "PATCH response (summary):"
          echo "$patch_resp" | jq -r '"id: \(.id)\nname: \(.name)\ndomain_name: \(.domain_name)\nregistry_image: \(.registry_image)"'

          actual_image="$(echo "$patch_resp" | jq -r '.registry_image // ""' | xargs)"
          if [ "$actual_image" != "$image" ]; then
            echo "ERROR: Scaleway container registry_image does not match expected '${image}'" >&2
            echo "Actual: '${actual_image}'" >&2
            echo "$patch_resp" | cat
            exit 1
          fi

          echo "Deploying API container revision"
          deploy_resp="$(
            curl -fsS -X POST \
            -H "X-Auth-Token: ${SCW_SECRET_KEY}" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            "https://api.scaleway.com/containers/v1beta1/regions/${region}/containers/${container_id}/deploy" \
            -d "{}" \
          )"

          echo "DEPLOY response (summary):"
          echo "$deploy_resp" | jq -r '"id: \(.id)\nstatus: \(.status)\nerror_message: \(.error_message)"'

          echo "Fetching container after deploy:"
          curl -fsS \
            -H "X-Auth-Token: ${SCW_SECRET_KEY}" \
            -H "Accept: application/json" \
            "${container_url}" \
            | jq -r '"domain_name: \(.domain_name)\nstatus: \(.status)\nregistry_image: \(.registry_image)"'

      - name: Deploy Worker container
        if: ${{ env.SCW_CONTAINER_ID_WORKER != '' }}
        shell: bash
        run: |
          set -euo pipefail

          region="${SCW_REGION}"
          container_id="${SCW_CONTAINER_ID_WORKER}"
          image="${SCW_REGISTRY}/pont-facturx-worker:${{ steps.vars.outputs.tag }}"

          echo "Target (Worker): region='${region}' container_id='${container_id}'"
          if ! [[ "$container_id" =~ ^[0-9a-fA-F-]{36}$ ]]; then
            echo "WARN: SCW_CONTAINER_ID_WORKER doesn't look like a UUID: '${container_id}'" >&2
          fi

          container_url="https://api.scaleway.com/containers/v1beta1/regions/${region}/containers/${container_id}"
          echo "Preflight GET ${container_url}"
          http_code="$(curl -sS -o /tmp/scw_container_worker.json -w "%{http_code}" \
            -H "X-Auth-Token: ${SCW_SECRET_KEY}" \
            -H "Accept: application/json" \
            "${container_url}" || true)"
          if [ "${http_code}" != "200" ]; then
            echo "ERROR: Preflight GET failed (HTTP ${http_code}). Check SCW_REGION/SCW_CONTAINER_ID_WORKER/SCW_SECRET_KEY project." >&2
            cat /tmp/scw_container_worker.json || true
            exit 1
          fi

          echo "Updating Worker container to ${image}"
          patch_resp="$(
            curl -fsS -X PATCH \
            -H "X-Auth-Token: ${SCW_SECRET_KEY}" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            "https://api.scaleway.com/containers/v1beta1/regions/${region}/containers/${container_id}" \
            -d "{\"registry_image\":\"${image}\"}" \
          )"

          echo "PATCH response (summary):"
          echo "$patch_resp" | jq -r '"id: \(.id)\nname: \(.name)\ndomain_name: \(.domain_name)\nregistry_image: \(.registry_image)"'

          actual_image="$(echo "$patch_resp" | jq -r '.registry_image // ""' | xargs)"
          if [ "$actual_image" != "$image" ]; then
            echo "ERROR: Scaleway container registry_image does not match expected '${image}'" >&2
            echo "Actual: '${actual_image}'" >&2
            echo "$patch_resp" | cat
            exit 1
          fi

          echo "Deploying Worker container revision"
          deploy_resp="$(
            curl -fsS -X POST \
            -H "X-Auth-Token: ${SCW_SECRET_KEY}" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            "https://api.scaleway.com/containers/v1beta1/regions/${region}/containers/${container_id}/deploy" \
            -d "{}" \
          )"

          echo "DEPLOY response (summary):"
          echo "$deploy_resp" | jq -r '"id: \(.id)\nstatus: \(.status)\nerror_message: \(.error_message)"'

          echo "Fetching container after deploy:"
          curl -fsS \
            -H "X-Auth-Token: ${SCW_SECRET_KEY}" \
            -H "Accept: application/json" \
            "${container_url}" \
            | jq -r '"domain_name: \(.domain_name)\nstatus: \(.status)\nregistry_image: \(.registry_image)"'
